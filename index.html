<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coluz</title>
    <style>
        :root { --bg: #36393f; --side: #2f3136; --dark: #202225; --text: #dcddde; --accent: #5865f2; --owner: #ffaa00; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* EL SECRETO: Esquina superior derecha, invisible pero clickeable */
        #secret-trigger { 
            position: fixed; 
            top: 0; 
            right: 0; 
            width: 60px; 
            height: 60px; 
            z-index: 9999; 
            cursor: default; 
        }

        /* Sidebar */
        #sidebar { width: 260px; background: var(--side); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #222; }
        .profile-card { background: var(--dark); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #444; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; background: var(--accent); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 2px solid #fff; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Chat */
        #main { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; list-style: none; margin: 0; }
        .m { margin-bottom: 15px; }
        .u { font-weight: bold; color: #fff; cursor: pointer; text-decoration: underline transparent; transition: 0.2s; }
        .u:hover { text-decoration: underline #fff; }
        .t { background: #40444b; padding: 10px 15px; border-radius: 0 15px 15px 15px; display: inline-block; max-width: 80%; margin-top: 5px; line-height: 1.4; }

        /* Popout de Usuario */
        #user-popout { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--side); padding: 30px; border-radius: 15px; border: 2px solid var(--accent); z-index: 1000; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.8); min-width: 250px; }
        #user-popout .avatar { width: 80px; height: 80px; font-size: 32px; }
        #user-popout button { margin-top: 20px; background: #ed4245; padding: 8px 20px; }

        /* Estilos generales */
        #form { padding: 20px; background: var(--bg); display: flex; }
        input { flex: 1; background: #40444b; border: none; padding: 12px; color: white; border-radius: 8px; outline: none; }
        button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-left: 10px; cursor: pointer; font-weight: bold; }
        .owner-tag { color: var(--owner) !important; font-weight: bold; font-size: 0.8em; border: 1px solid var(--owner); padding: 1px 4px; border-radius: 4px; margin-left: 5px; }
        
        /* Pantalla de Inicio */
        #auth { position: fixed; inset: 0; background: var(--dark); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .box { background: var(--side); padding: 40px; border-radius: 15px; text-align: center; width: 300px; }
        .box h1 { color: var(--accent); margin-top: 0; }
        .box input[type="text"] { width: 90%; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="secret-trigger" onclick="activateOwner()"></div>

    <div id="user-popout">
        <div class="avatar" id="pop-avatar" style="margin: 0 auto;"></div>
        <h2 id="pop-name" style="margin: 10px 0;"></h2>
        <p id="pop-desc" style="color: #b9bbbe; font-size: 14px;"></p>
        <button onclick="closePopout()">Cerrar</button>
    </div>

    <div id="auth">
        <div class="box">
            <h1>Coluz</h1>
            <input type="text" id="user" placeholder="Nombre de usuario"><br>
            <input type="text" id="desc" placeholder="Estado/Descripción"><br>
            <label style="color: #888; font-size: 11px; display: block; margin: 10px 0 5px;">Foto de perfil:</label>
            <input type="file" id="pfp-input" accept="image/*" style="font-size: 11px; color: #888;"><br><br>
            <button onclick="entrar()" style="width: 100%; margin: 0;">Entrar a Coluz</button>
        </div>
    </div>

    <div id="sidebar">
        <h2 style="color:var(--accent); margin-bottom: 25px;">Coluz</h2>
        <div class="profile-card">
            <div class="avatar" id="p-avatar">?</div>
            <h3 id="p-name" style="margin: 5px 0;">Invitado</h3>
            <div id="p-badge"></div>
            <p id="p-desc" style="font-size: 12px; color: #b9bbbe; margin-top: 8px;"></p>
        </div>
    </div>

    <div id="main">
        <ul id="messages"></ul>
        <form id="form">
            <input id="input" placeholder="Enviar mensaje a Coluz..." autocomplete="off">
            <button>Enviar</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        let myuser = "", mydesc = "", mypfp = "", isOwner = false;

        // Función Secreta Chasm
        function activateOwner() {
            if(prompt("Acceso Chasm:") === "Chasm") {
                isOwner = true;
                document.getElementById('p-badge').innerHTML = '<span class="owner-tag" style="background:var(--owner); color:black; font-size:10px; padding:2px 8px; border-radius:10px; display:inline-block; margin-top:5px;">OWNER</span>';
                alert("Bienvenido, Chasm. Rango de Dueño activado.");
            }
        }

        function entrar() {
            myuser = document.getElementById('user').value;
            mydesc = document.getElementById('desc').value || "Chateando en Coluz";
            const fileInput = document.getElementById('pfp-input');
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onloadend = function() {
                mypfp = reader.result;
                if(myuser) {
                    document.getElementById('p-name').innerText = myuser;
                    document.getElementById('p-desc').innerText = mydesc;
                    document.getElementById('p-avatar').innerHTML = mypfp ? `<img src="${mypfp}">` : myuser[0].toUpperCase();
                    document.getElementById('auth').style.display = 'none';
                } else { alert("Ponte un nombre, galactomany"); }
            }
            if (file) reader.readAsDataURL(file); else reader.onloadend();
        }

        document.getElementById('form').addEventListener('submit', (e) => {
            e.preventDefault();
            const inp = document.getElementById('input');
            if (inp.value && myuser) {
                socket.emit('chat message', { u: myuser, t: inp.value, d: mydesc, p: mypfp, o: isOwner });
                inp.value = '';
            }
        });

        socket.on('chat message', (data) => {
            const m = document.getElementById('messages');
            const li = document.createElement('li');
            li.className = 'm';
            const tag = data.o ? '<span class="owner-tag">OWNER</span>' : '';
            const miniPFP = data.p ? `<img src="${data.p}" style="width:24px; height:24px; border-radius:50%; vertical-align:middle; margin-right:8px; object-fit:cover;">` : '';
            
            li.innerHTML = `
                <div style="display:flex; align-items:center;">
                    ${miniPFP}
                    <span class="u" onclick="viewProfile('${data.u}', '${data.d.replace(/'/g, "\\'")}', '${data.p || ''}')">${data.u}${tag}</span>
                </div>
                <span class="t">${data.t}</span>
            `;
            m.appendChild(li);
            m.scrollTop = m.scrollHeight;
        });

        function viewProfile(name, desc, pfp) {
            document.getElementById('pop-name').innerText = name;
            document.getElementById('pop-desc').innerText = desc;
            document.getElementById('pop-avatar').innerHTML = pfp ? `<img src="${pfp}">` : name[0].toUpperCase();
            document.getElementById('user-popout').style.display = 'block';
        }

        function closePopout() { document.getElementById('user-popout').style.display = 'none'; }
    </script>
</body>
</html>